<?xml version="1.0" encoding="utf-8" standalone="yes"?><?xml-stylesheet href="/feed_style.xsl" type="text/xsl"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="https://www.rssboard.org/media-rss">
  <channel>
    <title>Master on Shakil&#39;s Blog</title>
    <link>http://localhost:1313/tags/master/</link>
    <description>Recent content in Master on Shakil&#39;s Blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <copyright>Shakil Hossain - All Right Reserved.</copyright>
    <lastBuildDate>Thu, 16 May 2024 12:44:59 +0200</lastBuildDate><atom:link href="http://localhost:1313/tags/master/index.xml" rel="self" type="application/rss+xml" /><icon>http://localhost:1313/logo.svg</icon>
    
    
    <item>
      <title>HTB Sherlock BFT</title>
      <link>http://localhost:1313/posts/htb-sherlocks/bft/</link>
      <pubDate>Thu, 16 May 2024 12:44:59 +0200</pubDate>
      
      <guid>http://localhost:1313/posts/htb-sherlocks/bft/</guid>
      <description><![CDATA[<h1 id="bft-dfir">BFT (DFIR)</h1>
<h3 id="scenario">Scenario</h3>
<p>In this Sherlock, you will become acquainted with MFT (Master File Table) forensics. You will be introduced to well-known tools and methodologies for analyzing MFT artifacts to identify malicious activity. During our analysis, you will utilize the MFTECmd tool to parse the provided MFT file, TimeLine Explorer to open and analyze the results from the parsed MFT, and a Hex editor to recover file contents from the MFT.</p>
<h3 id="forensics">Forensics</h3>
<ul>
<li><strong>Artifact</strong>: An MFT file <code>$MFT</code> is provided. It&rsquo;s an NTFS file system&rsquo;s master file table. <a href="https://hshakilst.github.io/posts/master-file-table/">Learn more about MFT here</a>.</li>
<li><strong>Extraction</strong>: I used <code>MFTECmd</code> to extract the contents of it and saved it to a file in CSV format.</li>
<li><strong>Analysis</strong>: <code>Timeline Explorer</code> and <code>010Editor</code> were used to answer the questions.</li>
</ul>
<h3 id="tools-used">Tools Used</h3>
<ul>
<li><a href="https://github.com/EricZimmerman/MFTECmd">MFTECmd by Eric Zimmerman</a></li>
<li><a href="https://ericzimmerman.github.io/#!index.md">Timeline Explorer</a></li>
<li><a href="https://www.sweetscape.com/download/010editor/">010Editor Hex Editor</a></li>
</ul>
<h3 id="questions-and-answers">Questions and Answers</h3>
<ul>
<li>
<p>Q1: Simon Stark was targeted by attackers on February 13. He downloaded a ZIP file from a link received in an email. What was the name of the ZIP file he downloaded from the link?</p>
<ul>
<li>A: The answer is <code>Stage-20240213T093324Z-001.zip</code>. I applied a filter on the header <code>Created0x10</code> with the date <code>2024-02-13</code> and on the header <code>Extension</code> with the value <code>.zip</code>.</li>
</ul>
</li>
<li>
<p>Q2: Examine the Zone Identifier contents for the initially downloaded ZIP file. This field reveals the HostUrl from where the file was downloaded, serving as a valuable Indicator of Compromise (IOC) in our investigation/analysis. What is the full Host URL from where this ZIP file was downloaded?</p>
<ul>
<li>
<p>A: The answer is <code>https://storage.googleapis.com/drive-bulk-export-anonymous/20240213T093324.039Z/4133399871716478688/a40aecd0-1cf3-4f88-b55a-e188d5c1c04f/1/c277a8b4-afa9-4d34-b8ca-e1eb5e5f983c?authuser</code>.</p>
<p>To find the URL of the downloaded file I needed to locate the <code>Stage-20240213T093324Z-001.zip:Zone.Identifier</code> file by applying a filter on <code>Extension</code> with the value <code>.Identifier</code>. The <code>Zone.Identifier</code> file separated by a <code>:</code> after the original file is an <strong>Alternate Data Stream (ADS)</strong> file. It contains the file&rsquo;s origin Location. In this case, it was a URL. It can be found under the <code>Zone Id Contents</code> header.</p>
</li>
</ul>
</li>
<li>
<p>Q3: What is the full path and name of the malicious file that executed malicious code and connected to a C2 server?</p>
<ul>
<li>A: The answer is <code>C:\Users\simon.stark\Downloads\Stage-20240213T093324Z-001\Stage\invoice\invoices\invoice.bat</code>. The file was found by applying a filter on the header <code>Parent Path</code> with the initial zip file&rsquo;s partial name <code>Stage</code> and a suspicious <code>.bat</code> file was discovered.</li>
</ul>
</li>
<li>
<p>Q4: Analyze the $Created0x30 timestamp for the previously identified file. When was this file created on disk?</p>
<ul>
<li>A: The answer is <code>2024-02-13 16:38:39</code>. <a href="https://hshakilst.github.io/posts/master-file-table/#timestamps">Learn more about the difference between $Created0x10 and $Created0x30</a>.</li>
</ul>
</li>
<li>
<p>Q5: Finding the hex offset of an MFT record is beneficial in many investigative scenarios. Find the hex offset of the stager file from Question 3.</p>
<ul>
<li>A: The answer is <code>16E3000</code>. To find the answer I needed to look for the malicious file&rsquo;s <code>Entry Number</code> which was <code>23436</code>. Then I multiplied it with 1024 <code>23436*1024</code> because each entry in the MFT is <code>1024 bytes</code> in size. After that, I converted the Decimal number to Hex.</li>
</ul>
</li>
<li>
<p>Q6: Each MFT record is 1024 bytes in size. If a file on disk has smaller size than 1024 bytes, they can be stored directly on MFT File itself. These are called MFT Resident files. During Windows File system Investigation, its crucial to look for any malicious/suspicious files that may be resident in MFT. This way we can find contents of malicious files/scripts. Find the contents of The malicious stager identified in Question3 and answer with the C2 IP and port.</p>
<ul>
<li>
<p>A: The answer is <code>43.204.110.203:6666</code>.</p>
<p>I had the hex offset for the <code>invoice.bat</code> file&rsquo;s entry and from the <strong>Timeline Explorer</strong>, and I discovered the <code>File Size</code> was <code>286 bytes</code>. So, it can be safely assumed it is an <a href="https://hshakilst.github.io/posts/master-file-table/#mft-resident-files"><code>MFT Resident</code> file</a>. The contents of this file can be viewed using a Hex Editor.</p>
<p>I opened up my Hex Editor went to the offset <code>16E3000</code> and found the file&rsquo;s contents. It used <code>powershell</code> to download a payload from the above IP.</p>
</li>
</ul>
</li>
</ul>
<h3 id="summary">Summary</h3>
<p>Using the MFT file I was able to discover a stager file residing in MFT and the URL which was used to deliver it initially. I also discovered a C2 server by reading the contents of that file. A timeline for this incident was also established using Timeline Explorer.</p>
]]></description>
      
    </item>
    
    
    
    <item>
      <title>Master File Table</title>
      <link>http://localhost:1313/posts/master-file-table/</link>
      <pubDate>Thu, 16 May 2024 11:20:29 +0200</pubDate>
      
      <guid>http://localhost:1313/posts/master-file-table/</guid>
      <description><![CDATA[<h2 id="what-is-a-master-file-table">What is a Master File Table?</h2>
<p>The Master File Table (MFT) is a system file in the NTFS file system (having the name $MFT) that stores metadata information about all files and directories on an NTFS volume. The MFT acts as an index to all the files and directories on the volume, providing quick access to the information needed to retrieve a file.</p>
<p>Each file and directory on an NTFS volume has a unique record in the MFT, known as an MFT entry. The MFT entry contains information such as the file name, timestamps, permissions, and a pointer to the file’s data. The corresponding MFT entry is updated when a file is created or modified.</p>
<p>When a file is deleted, the corresponding MFT entry is marked as free, but the actual file data remains on the disk until it is overwritten by new data. This can be useful in data recovery scenarios, as the deleted file’s data may still be recoverable. Successful data recovery requires that the Disk regions occupied by the deleted data are not overwritten.</p>
<p><strong>Note: The MFT is stored on the NTFS volume and is an important component of the NTFS file system. The MFT must remain intact and undamaged for the file system to function properly.</strong></p>
<h2 id="why-is-the-mft-useful-for-forensics">Why is the MFT Useful for Forensics?</h2>
<ol>
<li>
<p><strong>Comprehensive Data Storage</strong>: The MFT provides a detailed record of each file, including
timestamps, permissions, and data content locations, making it invaluable for forensic
investigations.</p>
</li>
<li>
<p><strong>Recovery of Deleted Files</strong>: Even when files are deleted, their MFT entries might not be
immediately reused. This allows forensic analysts to recover details about the deleted files,
which can be crucial in legal contexts.</p>
</li>
<li>
<p><strong>Tracking File Modifications</strong>: The MFT includes multiple timestamps that record different
types of file access and modifications. This can help construct a timeline of activities on a
system, an essential aspect of forensic analysis.</p>
</li>
<li>
<p><strong>Detecting Malware and Unauthorized Access</strong>: Since the MFT records file creation and
modification details, unusual changes detected in these entries can indicate unauthorised
access or malware activity.</p>
</li>
</ol>
<h2 id="general-structure-of-mft-record">General Structure of MFT Record</h2>
<p>The structure of the Master File Table (MFT) in the NTFS file system is complex and consists of multiple records, each of which represents a file or directory on the NTFS volume. Each MFT record is 1024 bytes, making the MFT very simple to parse. An MFT record has the following general structure:</p>
<ul>
<li>
<p><strong>File Record Header</strong>: This section contains information about the record itself, including the size of the record, the offset of the update sequence, and the flags that indicate the state of the file or directory.</p>
</li>
<li>
<p><strong>File Attribute List</strong>: This section contains a list of attributes that describe the file or directory, including its name, timestamps, size, and data. Each attribute is stored as a separate structure with its format.</p>
</li>
<li>
<p><strong>Data Runs</strong>: This section describes the location of the file or directory’s data on the disk. The data runs are stored as a series of extents describing the starting cluster and the length of each contiguous data block.</p>
</li>
</ul>
<p>The exact format and structure of the MFT in NTFS can vary depending on the version of the file system in use. However, the general structure remains the same, with the File Record Header, File Attribute List, and Data Runs being the main components of each MFT entry.</p>
<p><strong>Note: It’s important to note that accessing the MFT directly can be dangerous and potentially lead to file system corruption or data loss. Before attempting to access or modify the MFT, it’s recommended to perform operations on a backup of the MFT or back up important data beforehand.</strong></p>
<h2 id="detailed-breakdown-of-mft-fields">Detailed Breakdown of MFT Fields</h2>
<ol>
<li>
<p><strong>$STANDARD_INFORMATION</strong></p>
<ul>
<li><strong>Creation Time</strong>: The date and time when the file or directory was created.</li>
<li><strong>Modification Time</strong>: The date and time when the file or directory was last modified.</li>
<li><strong>Access Time</strong>: The date and time when the file or directory was last accessed.</li>
<li><strong>Entry Modified Time</strong>: The date and time when the MFT entry itself was last modified.</li>
<li><strong>Use Case</strong>: These timestamps are vital for timeline analysis to determine the sequence of user actions and file usage.</li>
</ul>
</li>
<li>
<p><strong>$FILE_NAME</strong></p>
<ul>
<li><strong>File Name</strong>: The name of the file or directory.</li>
<li>Parent Directory: The MFT record number of the directory in which the file resides.</li>
<li><strong>Additional Timestamps</strong>: Similar to $STANDARD_INFORMATION, but specific to this attribute and sometimes used as a fallback.</li>
<li><strong>Use Case</strong>: This attribute is used to confirm the integrity of file paths and names in the system, which is crucial for tracking user movements and detecting unauthorised changes.</li>
</ul>
</li>
<li>
<p><strong>$DATA</strong></p>
<ul>
<li><strong>Actual Data or Pointer</strong>: Either the data itself for smaller files or a pointer to the data for larger files.</li>
<li><strong>Use Case</strong>: Direct analysis of file contents and data recovery, especially important in cases involving data theft or unauthorized data manipulation.</li>
</ul>
</li>
<li>
<p><strong>$LOGGED_UTILITY_STREAM</strong></p>
<ul>
<li><strong>Transactional Data</strong>: Holds data related to transactional NTFS (TxF), which logs temporary file state changes.</li>
<li><strong>Use Case</strong>: Can be used to track changes made during a transaction, useful in cases of system crashes or unexpected shutdowns to determine interim states.</li>
</ul>
</li>
<li>
<p><strong>$BITMAP</strong></p>
<ul>
<li><strong>Cluster Allocation</strong>: Maps which clusters are in use by the file.</li>
<li><strong>Use Case</strong>: Useful for recovering deleted files or reconstructing file data from clusters not overwritten by new data.</li>
</ul>
</li>
<li>
<p><strong>$SECURITY_DESCRIPTOR</strong></p>
<ul>
<li><strong>Owner ID</strong>: Identifies who owns the file.</li>
<li><strong>Permissions</strong>: Details what permissions are attached to the file (who can read, write, execute, etc.).</li>
<li><strong>Audit Settings</strong>: Specifies what operations (like access or changes) are logged by the system.</li>
<li><strong>Use Case</strong>: Critical for determining access rights and detecting potential security breaches where permissions may have been altered.</li>
</ul>
</li>
<li>
<p><strong>$VOLUME_INFORMATION</strong> (specific to the MFT entry for the volume itself)</p>
<ul>
<li><strong>Volume Serial Number</strong>: Unique identifier for the volume.</li>
<li><strong>Flags</strong>: System flags related to the volume, such as whether it’s dirty (improperly unmounted).</li>
<li><strong>Use Case</strong>: Useful in multi-disk systems to link files and activities to specific volumes, essential in systems recovery and forensic analysis across multiple drives.</li>
</ul>
</li>
<li>
<p><strong>$INDEX_ROOT</strong> and <strong>$INDEX_ALLOCATION</strong></p>
<ul>
<li><strong>Index Entries</strong>: Used in directories to index contained files for quick access.</li>
<li><strong>Use Case</strong>: Forensically important for reconstructing directory structures and understanding how data was organized and accessed, particularly in complex investigations involving numerous files and directories.</li>
</ul>
</li>
</ol>
<h2 id="timestamps">Timestamps</h2>
<p>Created (0x10) is the Standard Information (SI) creation timestamp. This can be modified by user level processes, for example, timestomping. Created (0x30) is the FileName (FN) creation timestamp.</p>
<p>Timestamps of (FN) - behave differently from timestamps of (SI). These values don&rsquo;t change or all of the values change at once. However, rename and moved in a local volume are exceptions. These processes are inherited from (SI) value then set corresponding (FN) value. For more <a href="http://www.kazamiya.net/en/NTFS_Timestamps">NTFS Timestamps</a>.</p>
<h2 id="mft-resident-files">MFT Resident Files</h2>
<p>Files that can be stored directly within the Master File Table (MFT) known as resident files. The size of this kind of files varies depending on the file, the system, and the amount of metadata stored in the MFT.</p>
<p>Generally, the more metadata associated with a file, the less space remains for storing the file&rsquo;s data itself within the MFT. While there is no strict upper limit, typically files smaller than approximately 900 bytes can be fully contained within their MFT record.</p>
<h3 id="references">References</h3>
<ul>
<li><a href="https://www.geeksforgeeks.org/what-is-a-master-file-table/">GeeksForGeeks</a></li>
<li><a href="http://www.kazamiya.net/en/NTFS_Timestamps">Kazamiya</a></li>
<li><a href="BFT-Write-Up.pdf">Official Writeup BFT by Cyberjunkie &amp; Sebh24 on HTB</a></li>
</ul>
]]></description>
      
    </item>
    
    
  </channel>
</rss>
